<!DOCTYPE html>
<html lang="es">
<head>
   <meta charset="UTF-8">
   <title>Análisis FAIS</title>
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
   <style>
       :root {
           --primary-color: #0066cc;
       }

       body { 
           font-family: 'Segoe UI', Arial, sans-serif; 
           background-color: #f8f9fa;
           margin: 0;
           padding: 20px;
       }

       .app-container {
           max-width: 1200px;
           margin: 0 auto;
           background: white;
           padding: 2rem;
           border-radius: 12px;
           box-shadow: 0 2px 12px rgba(0,0,0,0.1);
       }

       .app-header {
           margin-bottom: 2rem;
           padding-bottom: 1rem;
           border-bottom: 2px solid #eee;
       }

       .app-title {
           color: var(--primary-color);
           font-size: 1.5rem;
           margin: 0;
       }

       .filters { 
           display: grid;
           grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
           gap: 1rem;
           margin-bottom: 2rem;
           background: white;
           padding: 1.5rem;
           border-radius: 8px;
       }

       select { 
           width: 100%;
           padding: 0.75rem;
           border: 1px solid #ddd;
           border-radius: 6px;
           font-size: 0.9rem;
           transition: all 0.3s ease;
       }

       select:hover {
           border-color: #0066cc;
       }

       select:disabled {
           background-color: #f5f5f5;
           cursor: not-allowed;
       }

       .button-container {
           display: flex;
           gap: 1rem;
           margin-top: 2rem;
       }

       button {
           display: inline-flex;
           align-items: center;
           gap: 0.5rem;
           padding: 0.75rem 1.5rem;
           border: none;
           border-radius: 6px;
           font-weight: 500;
           cursor: pointer;
           transition: all 0.3s ease;
       }

       button:disabled {
           opacity: 0.7;
           cursor: not-allowed;
       }

       #generarAnalisis {
           background-color: #0066cc;
           color: white;
       }

       #generarAnalisis:hover:not(:disabled) {
           background-color: #0052a3;
       }

       #exportarExcel {
           background-color: #28a745;
           color: white;
       }

       #exportarExcel:hover:not(:disabled) {
           background-color: #218838;
       }

       #limpiarFiltros {
           background-color: #6c757d;
           color: white;
       }

       #limpiarFiltros:hover {
           background-color: #5a6268;
       }

       .loading {
           position: fixed;
           top: 0;
           left: 0;
           right: 0;
           bottom: 0;
           background: rgba(255,255,255,0.8);
           display: flex;
           justify-content: center;
           align-items: center;
           z-index: 1000;
       }

       .loading-spinner {
           width: 40px;
           height: 40px;
           border: 4px solid #f3f3f3;
           border-top: 4px solid #0066cc;
           border-radius: 50%;
           animation: spin 1s linear infinite;
       }

       @keyframes spin {
           0% { transform: rotate(0deg); }
           100% { transform: rotate(360deg); }
       }

       #errorMessage {
           background-color: #fff3f3;
           border: 1px solid #dc3545;
           color: #dc3545;
           padding: 1rem;
           border-radius: 6px;
           margin: 1rem 0;
           display: none;
       }

       .generating-analysis {
           pointer-events: none;
           opacity: 0.7;
       }

       .footer {
           margin-top: 3rem;
           padding-top: 2rem;
           border-top: 2px solid #eee;
           text-align: center;
       }

       .footer-content {
           display: flex;
           flex-direction: column;
           gap: 0.5rem;
           color: #666;
           font-size: 0.9rem;
       }

       .footer-content a {
           color: #0066cc;
           text-decoration: none;
           transition: color 0.3s ease;
       }

       .footer-content a:hover {
           color: #0052a3;
       }

       .footer-content i {
           margin-right: 0.5rem;
       }

       .copyright {
           margin-top: 1rem;
           font-size: 0.8rem;
           color: #888;
       }
   </style>
</head>
<body>
   <div class="app-container">
       <header class="app-header">
           <h1 class="app-title">Análisis FAIS</h1>
       </header>
       
<!-- Librerías necesarias -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

       <div id="loadingMessage" class="loading">
           <div class="loading-spinner"></div>
       </div>

       <div id="errorMessage"></div>
       
       <div class="filters" id="filtersContainer" style="display: none;">
           <div class="filter-group">
               <select id="estado">
                   <option value="">Selecciona Estado</option>
               </select>
           </div>
           
           <div class="filter-group">
               <select id="ciclo">
                   <option value="">Selecciona Ciclo</option>
               </select>
           </div>
           
           <div class="filter-group">
               <select id="programa">
                   <option value="">Selecciona Programa</option>
               </select>
           </div>
           
           <div class="filter-group" id="municipioContainer">
               <select id="municipio" disabled>
                   <option value="">Selecciona Municipio</option>
               </select>
           </div>
       </div>

       <div class="button-container">
           <button id="generarAnalisis" disabled>
               <i class="fas fa-chart-bar"></i>
               Generar Análisis
           </button>
           <button id="exportarExcel" disabled>
               <i class="fas fa-file-excel"></i>
               Exportar a Excel
           </button>
           <button id="limpiarFiltros">
               <i class="fas fa-broom"></i>
               Limpiar Filtros
           </button>
       </div>

       <div class="footer">
           <div class="footer-content">
               <p>
                   <a href="mailto:juanheriberto.rosas@gobiernodigitaleinnovacion.com">
                       <i class="fas fa-envelope"></i> 
                       juanheriberto.rosas@gobiernodigitaleinnovacion.com
                   </a>
               </p>
               <p>
                   <a href="https://www.gobiernodigitaleinnovacion.com/" target="_blank">
                       <i class="fas fa-globe"></i> 
                       www.gobiernodigitaleinnovacion.com
                   </a>
               </p>
               <p class="copyright">
                   © 2024 Gobierno Digital e Innovación. Todos los derechos reservados.
               </p>
           </div>
       </div>
   </div>
    <script>
        // Configuración inicial
        const baseUrl = 'https://stindicadores.blob.core.windows.net/estados-fais/';
        const sasToken = 'sp=r&st=2024-10-30T21:15:16Z&se=2026-10-31T05:15:16Z&spr=https&sv=2022-11-02&sr=c&sig=okiG4MWLVsgE37DUov5YBZcbXqjYOd%2BKcOnNh0TYN2s%3D';

        // Variables globales
        let fullData = [];
        let filteredData = [];

        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            initialize();
            setupEventListeners();
        });

        // Función de inicialización
        async function initialize() {
            try {
                document.getElementById('loadingMessage').style.display = 'block';
                const estados = Object.keys(estadosMapping).sort();
                populateSelect('estado', estados);
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('filtersContainer').style.display = 'grid';
            } catch (error) {
                document.getElementById('loadingMessage').style.display = 'none';
                console.error('Error en inicialización:', error);
            }
        }

        // Configuración de event listeners
        function setupEventListeners() {
            document.getElementById('estado').addEventListener('change', handleEstadoChange);
            document.getElementById('programa').addEventListener('change', handleProgramaChange);
            document.getElementById('ciclo').addEventListener('change', handleCicloChange);
            document.getElementById('municipio').addEventListener('change', handleMunicipioChange);
            document.getElementById('generarAnalisis').addEventListener('click', handleGenerarAnalisis);
            document.getElementById('exportarExcel').addEventListener('click', handleExportarExcel);
            document.getElementById('limpiarFiltros').addEventListener('click', handleLimpiarFiltros);
        }

        // Manejadores de eventos
        async function handleEstadoChange() {
            try {
                const estadoSeleccionado = this.value;
                if (estadoSeleccionado) {
                    document.getElementById('loadingMessage').style.display = 'block';
                    fullData = await fetchExcelData(estadoSeleccionado);
                    
                    const ciclos = [...new Set(fullData
                        .map(item => item['CICLO DEL RECURSO'])
                        .filter(Boolean)
                    )].sort((a, b) => b - a);
                    
                    const programas = [...new Set(fullData
                        .map(item => item['PROGRAMA PRESUPUESTARIO'])
                        .filter(Boolean)
                    )].sort();
                    
                    populateSelect('ciclo', ciclos);
                    populateSelect('programa', programas);
                    
                    document.getElementById('loadingMessage').style.display = 'none';
                }
                
                document.getElementById('municipio').value = '';
                updateMunicipios();
                filterData();
            } catch (error) {
                document.getElementById('loadingMessage').style.display = 'none';
                console.error('Error al cargar datos del estado:', error);
            }
        }

        function handleProgramaChange() {
            const programa = this.value;
            document.getElementById('municipio').value = '';
            
            if (programa === 'I003-FAIS Entidades') {
                document.getElementById('municipioContainer').style.display = 'none';
                document.getElementById('municipio').disabled = true;
            } else {
                document.getElementById('municipioContainer').style.display = 'block';
                updateMunicipios();
            }
            
            filterData();
        }

        function handleCicloChange() {
            document.getElementById('municipio').value = '';
            updateMunicipios();
            filterData();
        }

        function handleMunicipioChange() {
            filterData();
        }

        async function handleGenerarAnalisis() {
            const boton = this;
            const textoOriginal = boton.textContent;
            
            try {
                boton.classList.add('generating-analysis', 'button-loading');
                boton.textContent = 'Generando análisis';
                boton.disabled = true;
                
                const programa = document.getElementById('programa').value;
                await generarInforme(filteredData, programa);
            } catch (error) {
                console.error('Error:', error);
                alert('Ocurrió un error al generar el informe. Por favor, intente nuevamente.');
            } finally {
                boton.classList.remove('generating-analysis', 'button-loading');
                boton.textContent = textoOriginal;
                boton.disabled = false;
            }
        }

        function handleExportarExcel() {
            const boton = this;
            const textoOriginal = boton.textContent;
            
            try {
                boton.classList.add('generating-analysis', 'button-loading');
                boton.textContent = 'Exportando datos';
                boton.disabled = true;

                exportarDatosExcel();
            } catch (error) {
                console.error('Error al exportar a Excel:', error);
                alert('Ocurrió un error al exportar los datos. Por favor, intente nuevamente.');
            } finally {
                boton.classList.remove('generating-analysis', 'button-loading');
                boton.textContent = textoOriginal;
                boton.disabled = false;
            }
        }

        function handleLimpiarFiltros() {
            document.getElementById('ciclo').value = '';
            document.getElementById('programa').value = '';
            document.getElementById('estado').value = '';
            document.getElementById('municipio').value = '';
            
            fullData = [];
            filteredData = [];
            
            document.getElementById('municipioContainer').style.display = 'block';
            document.getElementById('municipio').disabled = true;
            document.getElementById('generarAnalisis').disabled = true;
            document.getElementById('exportarExcel').disabled = true;
            document.getElementById('errorMessage').style.display = 'none';
            
            initialize();
        }

        // Funciones de utilidad
        function populateSelect(id, options) {
            const select = document.getElementById(id);
            select.innerHTML = '<option value="">Selecciona ' + id.charAt(0).toUpperCase() + id.slice(1) + '</option>';
            options.forEach(option => {
                if (option) {
                    const opt = document.createElement('option');
                    opt.value = option;
                    opt.textContent = option;
                    select.appendChild(opt);
                }
            });
        }

        function checkFiltersAndEnableButtons() {
            const ciclo = document.getElementById('ciclo').value;
            const programa = document.getElementById('programa').value;
            const estado = document.getElementById('estado').value;
            const municipio = document.getElementById('municipio').value;
            
            const isValid = ciclo && programa && estado && 
                           (programa === 'I003-FAIS Entidades' || 
                            programa === 'I004-FAIS Municipal y de las Demarcaciones Territoriales del Distrito Federal' ||
                            municipio);
            
            document.getElementById('generarAnalisis').disabled = !isValid;
            document.getElementById('exportarExcel').disabled = !isValid;
        }

        function updateMunicipios() {
            const estado = document.getElementById('estado').value;
            const programa = document.getElementById('programa').value;
            const esCDMX = estado === 'Ciudad de México';
            
            if (!fullData || fullData.length === 0) return;

            const datosFiltrados = fullData.filter(item => item['PROGRAMA PRESUPUESTARIO'] === programa);
            const municipios = [...new Set(datosFiltrados.map(item => 
                item.NOMBRE_MUNICIPIO || item.MUNICIPIO || item.ALCALDIA || ''
            ).filter(Boolean))].sort();
            
            document.getElementById('errorMessage').style.display = 'none';
            const municipioSelect = document.getElementById('municipio');
            const etiquetaSelector = esCDMX ? 'Alcaldía' : 'Municipio';
            
            municipioSelect.innerHTML = `<option value="">Selecciona ${etiquetaSelector}</option>`;
            
            if (!programa || programa === 'I003-FAIS Entidades') {
                municipioSelect.disabled = true;
                document.getElementById('municipioContainer').style.display = 
                    programa === 'I003-FAIS Entidades' ? 'none' : 'block';
                return;
            }

            if (programa.includes('I004') || programa.includes('I005')) {
                if (municipios.length > 0) {
                    municipioSelect.disabled = false;
                    document.getElementById('municipioContainer').style.display = 'block';
                    municipios.forEach(municipio => {
                        const opt = document.createElement('option');
                        opt.value = municipio;
                        opt.textContent = municipio;
                        municipioSelect.appendChild(opt);
                    });
                } else {
                    document.getElementById('errorMessage').textContent = 
                        `No se encontraron ${esCDMX ? 'alcaldías' : 'municipios'} para el programa ${programa}`;
                    document.getElementById('errorMessage').style.display = 'block';
                    municipioSelect.disabled = true;
                }
            }

            checkFiltersAndEnableButtons();
        }

        function filterData() {
            const ciclo = document.getElementById('ciclo').value;
            const programa = document.getElementById('programa').value;
            const estado = document.getElementById('estado').value;
            const municipio = document.getElementById('municipio').value;
            
            filteredData = fullData.filter(item => {
                const matchCiclo = !ciclo || item['CICLO DEL RECURSO'] === Number(ciclo);
                const matchPrograma = !programa || item['PROGRAMA PRESUPUESTARIO'] === programa;
                const matchEstado = !estado || item.NOMBRE_ENTIDAD === estado;
                const matchMunicipio = !municipio || 
                                     programa === 'I003-FAIS Entidades' || 
                                     item.NOMBRE_MUNICIPIO === municipio;
                
                return matchCiclo && matchPrograma && matchEstado && matchMunicipio;
            });
            
            checkFiltersAndEnableButtons();
        }

        // Mapeo de estados
        const estadosMapping = {
            'Aguascalientes': 'FAIS_Aguascalientes.xlsx',
            'Baja California': 'FAIS_Baja_California.xlsx',
            'Baja California Sur': 'FAIS_Baja_California_Sur.xlsx',
            'Campeche': 'FAIS_Campeche.xlsx',
            'Chiapas': 'FAIS_Chiapas.xlsx',
            'Chihuahua': 'FAIS_Chihuahua.xlsx',
            'Ciudad de México': 'FAIS_Ciudad_de_México.xlsx',
            'Coahuila de Zaragoza': 'FAIS_Coahuila_de_Zaragoza.xlsx',
            'Colima': 'FAIS_Colima.xlsx',
            'Durango': 'FAIS_Durango.xlsx',
            'Guanajuato': 'FAIS_Guanajuato.xlsx',
            'Guerrero': 'FAIS_Guerrero.xlsx',
            'Hidalgo': 'FAIS_Hidalgo.xlsx',
            'Jalisco': 'FAIS_Jalisco.xlsx',
            'México': 'FAIS_México.xlsx',
            'Michoacán de Ocampo': 'FAIS_Michoacán_de_Ocampo.xlsx',
            'Morelos': 'FAIS_Morelos.xlsx',
            'Nayarit': 'FAIS_Nayarit.xlsx',
            'Nuevo León': 'FAIS_Nuevo_León.xlsx',
            'Oaxaca': 'FAIS_Oaxaca.xlsx',
            'Puebla': 'FAIS_Puebla.xlsx',
            'Querétaro': 'FAIS_Querétaro.xlsx',
            'Quintana Roo': 'FAIS_Quintana_Roo.xlsx',
            'San Luis Potosí': 'FAIS_San_Luis_Potosí.xlsx',
            'Sinaloa': 'FAIS_Sinaloa.xlsx',
            'Sonora': 'FAIS_Sonora.xlsx',
            'Tabasco': 'FAIS_Tabasco.xlsx',
            'Tamaulipas': 'FAIS_Tamaulipas.xlsx',
            'Tlaxcala': 'FAIS_Tlaxcala.xlsx',
            'Veracruz de Ignacio de la Llave': 'FAIS_Veracruz_de_Ignacio_de_la_Llave.xlsx',
            'Yucatán': 'FAIS_Yucatán.xlsx',
            'Zacatecas': 'FAIS_Zacatecas.xlsx'
        };

        // Funciones de análisis y exportación
        async function fetchExcelData(estado) {
            try {
                const fileName = estadosMapping[estado];
                if (!fileName) {
                    throw new Error(`Archivo no encontrado para el estado: ${estado}`);
                }

                const fullUrl = `${baseUrl}${fileName}?${sasToken}`;
                const response = await fetch(fullUrl);
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const data = XLSX.utils.sheet_to_json(firstSheet);
                
                if (data.length === 0) {
                    throw new Error(`No se encontraron datos para el estado: ${estado}`);
                }

                return data.map(row => ({
                    ...row,
                    'CICLO DEL RECURSO': Number(row['CICLO DEL RECURSO']) || 0,
                    APROBADO: Number(row.APROBADO) || 0,
                    EJERCIDO: Number(row.EJERCIDO) || 0,
                    PAGADO: Number(row.PAGADO) || 0,
                    NOMBRE_ENTIDAD: row.NOMBRE_ENTIDAD || '',
                    NOMBRE_MUNICIPIO: row.NOMBRE_MUNICIPIO || row.MUNICIPIO || ''
                }));
            } catch (error) {
                console.error('Error al cargar datos:', error);
                document.getElementById('errorMessage').textContent = `Error al cargar los datos de ${estado}: ${error.message}`;
                document.getElementById('errorMessage').style.display = 'block';
                throw error;
            }
        }

        function exportarDatosExcel() {
            const wb = XLSX.utils.book_new();
            const dataToExport = filteredData.map(item => ({
                'Folio': item['FOLIO'],
                'Ciclo del Recurso': item['CICLO DEL RECURSO'],
                'Programa Presupuestario': item['PROGRAMA PRESUPUESTARIO'],
                'Estado': item['NOMBRE_ENTIDAD'],
                'Municipio': item['NOMBRE_MUNICIPIO'],
                'Localidad': item['LOCALIDAD'],
                'Monto Aprobado': item['APROBADO'],
                'Monto Ejercido': item['EJERCIDO'],
                'Monto Pagado': item['PAGADO'],
                'Estatus': item['ESTATUS'],
                'Porcentaje Avance': item['PORCENTAJE'],
                'Institución Ejecutora': item['INSTITUCION_EJECUTORA'],
                'Contratista': item['CONTRATISTA'],
                'Convocante': item['CONVOCANTE'],
                'Categoría': item['CATEGORIA'],
                'Tipo de Programa': item['TIPO_PROGRAMA_PROYECTO'],
                'Clasificación': item['CLASIFICACION'],
                'Beneficiarios Mujeres': item['MUJERES'],
                'Beneficiarios Hombres': item['HOMBRES'],
                'Fecha Inicio': item['FECHA_INICIO'],
                'Fecha Término': item['FECHA_TERMINO']
            }));

            const ws = XLSX.utils.json_to_sheet(dataToExport);
            ws['!cols'] = Object.keys(dataToExport[0]).map(() => ({ wch: 20 }));
            XLSX.utils.book_append_sheet(wb, ws, "Datos FAIS");

            const filtros = {
                ciclo: document.getElementById('ciclo').value,
                programa: document.getElementById('programa').value.split('-')[1],
                estado: document.getElementById('estado').value,
                municipio: document.getElementById('municipio').value
            };
            
            const nombreArchivo = `${filtros.ciclo}_${filtros.programa}_${filtros.estado}${filtros.municipio ? '_' + filtros.municipio : ''}.xlsx`;
            XLSX.writeFile(wb, nombreArchivo);
        }

        // Función de formato
        function formatNumber(number) {
            return new Intl.NumberFormat('es-MX', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(number);
        }
    </script>
</body>
</html>
